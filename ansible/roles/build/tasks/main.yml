---
- name: Verify Docker is installed
  command: docker --version
  register: docker_version
  changed_when: false
  become: yes

- name: Display Docker version
  debug:
    msg: "Docker version: {{ docker_version.stdout }}"

- name: Ensure Docker service is running
  systemd:
    name: docker
    state: started
    enabled: yes
  become: yes

- name: Install required packages
  package:
    name:
      - git
      - python3-pip
    state: present
  become: yes

- name: Generate random clone directory
  set_fact:
    final_clone_dest: "{{ git_clone_base_dir }}/{{ git_clone_prefix }}-{{ ansible_date_time.iso8601_basic_short }}"

- name: Ensure clone directory exists
  file:
    path: "{{ final_clone_dest }}"
    state: directory
    mode: '0755'

- name: Clone Git repository
  git:
    repo: "{{ git_repo_url }}"
    dest: "{{ final_clone_dest }}"
    version: "{{ git_branch | default('main') }}"
    update: yes
  register: git_clone_result

- name: Set Docker image tag with date
  set_fact:
    docker_image_tag: "{{ ansible_date_time.date ~ '-' ~ ansible_date_time.time | replace(':', '-') }}"

- name: Build Docker image
  docker_image:
    name: "{{ docker_image_name }}"
    tag: "{{ docker_image_tag | default('latest') }}"
    source: build
    build:
      path: "{{ final_clone_dest }}/app"
      dockerfile: "{{ dockerfile_path | default('Dockerfile') }}"
      pull: "{{ docker_build_pull | default(true) }}"
    state: present
  register: docker_build_result

- name: Capture full image name for later use
  set_fact:
    built_docker_image: "{{ docker_image_name }}:{{ docker_image_tag }}"
    docker_image_details:
      name: "{{ docker_image_name }}"
      tag: "{{ docker_image_tag }}"
      full_name: "{{ docker_image_name }}:{{ docker_image_tag }}"
      image_id: "{{ docker_build_result.image.Id | default('') }}"

- name: Display built image info
  debug:
    msg: "Built image: {{ built_docker_image }}"

